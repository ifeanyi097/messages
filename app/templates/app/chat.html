{%load static%}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat</title>
    <link rel="stylesheet" href="{%static 'app/chat.css' %}">
</head>
<body>
    <div class="head">

        <img src="" alt="User Image">
        {%if conversation %}
        {% for convo in conversation.participants.all %}
        {%if convo != user %}
        <h3>{{convo.username}}</h3>
        {% endif %}
        {%endfor%}
        {%else%}<h3>{{user.username}}</h3>{%endif%}
    </div>
    <div class="body" id="chatBody">
        <div class="message">
            <img src="" alt="User Image">
            <p>Lorem ipsum dolor sit amet.</p>
        </div>
        <div class="message me">
            <p>Lorem ipsum dolor sit amet.</p>
        </div>
    </div>
    <form class="input">
        <input type="text" name="message" id="messageInput" placeholder="Type a message...">
        <input type="submit" value="Send">
    </form>
    <input type="hidden" id="conversation" value={%if conversation %}"{{conversation.id}}"{%else%}"{{user.id}}"{%endif%}>
    <input type="hidden" id="username" value="{{user.username}}">
    <input type="hidden" id="csrf-token" value="{%csrf_token%}">
    <div id="response"></div>
    <script>
        const id = document.getElementById("conversation").value;
        const username = document.getElementById("username").value;

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrfToken = getCookie('csrftoken');





        let last_time = 0;


        function markRead(){

            fetch(`/chat/markread/${id}/`, {

                method: "POST",
                headers: {
                    "content-type":"application/json",
                    "X-CSRFToken": csrfToken
                }
            })
            .then(response => {
                if(!response.ok){
                    console.log('error')
                }
                return response.json()
            })
            .then(data => {
                console.log(data.status)
            })


        }





        const eventSource = new EventSource(`/chat/newMessage/${id}/`)

        eventSource.onmessage = function(event){
            const data = JSON.parse(event.data);
            const body = document.querySelector('.body');
            if(data.sender === username){
                body.innerHTML += `<div class="message me">
                            <p>${data.message}</p>
                            </div>`
                body.scrollTop = body.scrollHeight;
                markRead();

            }
            else{
                body.innerHTML += `<div class="message">
                           <img src="" alt="User Image">
                           <p>${data.message}</p>
                           </div>`
                body.scrollTop = body.scrollHeight;
                markRead();
            }
        }

        eventSource.onerror= function(){
            alert("error fetching data")
        }


                //body.scrillTop = body.scrollHeight;




        window.scrollToBottom;




        document.querySelector(".input").addEventListener('submit', (event) => {

            event.preventDefault();
            console.log('message')
            let message = document.getElementById('messageInput');

            fetch(`/chat/sendmessage/${id}/`, {
                method: "POST",
                headers: {
                    'content-type':'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({'message':message.value})
            })
            .then(response => {

                if(!response.ok){
                    alert('error');
                }
                return response.json()
            })
            .then(data => {
                console.log(data.status)
                message.value = ""

            })
        })

    </script>
</body>
</html>
